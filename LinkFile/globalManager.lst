C51 COMPILER V9.59.0.0   GLOBALMANAGER                                                     04/25/2019 14:08:00 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE GLOBALMANAGER
OBJECT MODULE PLACED IN .\bin\globalManager.obj
COMPILER INVOKED BY: G:\Keil_v5\C51\BIN\C51.EXE globalManager\globalManager.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEN
                    -D PRINT(.\LinkFile\globalManager.lst) TABS(2) OBJECT(.\bin\globalManager.obj)

line level    source

   1          #include "globalManager.h"
   2          //全局管理全局对象
   3          static  GlobalManager this;
   4          static  SensorValue   globalSensorValue;
   5          /**
   6           * @brief 上电的时候初始化整个单片机所有的参数函数
   7           */
   8          void g_initSystemParameter()
   9          {
  10   1          //定时器中断初始化
  11   1          interrupt1Init();
  12   1          //初始化串口
  13   1          uartInit();
  14   1          //函数的初始化
  15   1          this.controlMotor1StatusFunc=controlMotor1Status;
  16   1          this.controlMotor2StatusFunc=controlMotor2Status;
  17   1          this.handleSensorDataFunc=handleSensorData; 
  18   1          this.handleSendSmsInfoFunc=handleSendSmsInfo;
  19   1          this.handleControlMagnetFunc=handleControlMagnet;
  20   1      }
  21          const GlobalManager g_getGlobalManagerObj()
  22          {
  23   1        return this;
  24   1      }
  25          static const bool controlMotor1Status(const MotorStatus status)
  26          {
  27   1          switch(status){
  28   2            case Move_Up:               //正转
  29   2              Motor1ControlTurn(true,MOTOR1CIRCLENUMBER);
  30   2                    //todo把记录写入EEPROM
  31   2              return true;
  32   2            case Move_Down:              //反转
  33   2              Motor1ControlTurn(false,MOTOR1CIRCLENUMBER);
  34   2                    //todo把记录写入EEPROM
  35   2              return true;
  36   2            case Move_Stop:             //停止
  37   2              Motor1ControlStop();
  38   2              return true;
  39   2            default:
  40   2              return false;
  41   2          } 
  42   1      }
  43          static const bool controlMotor2Status(const MotorStatus status)
  44          {
  45   1          switch(status){
  46   2            case Move_Up:               //正转
  47   2              Motor2ControlTurn(true,MOTOR2CIRCLENUMBER);
  48   2              return true;
  49   2            case Move_Down:              //反转
  50   2              Motor2ControlTurn(false,MOTOR2CIRCLENUMBER);
  51   2              return true;
  52   2            case Move_Stop:             //停止
  53   2              Motor2ControlStop();
  54   2              return true;
C51 COMPILER V9.59.0.0   GLOBALMANAGER                                                     04/25/2019 14:08:00 PAGE 2   

  55   2            default:
  56   2              return false;
  57   2          } 
  58   1      }
  59          const bool handleSensorData(void)
  60          {
  61   1          DHT11Data dh11Data;
  62   1          memset(&dh11Data,0,sizeof(DHT11Data));
  63   1          memset(&globalSensorValue,0,sizeof(SensorValue));
  64   1          globalSensorValue.PhotosensitiveValue=getAdcValue(Channel1);//获取光敏传感器的数值(未转换公式)
  65   1          globalSensorValue.RaindropValue=getAdcValue(Channel2);//获取雨滴传感器的数值(未转换公式)
  66   1          globalSensorValue.WindSpeedValue=getAdcValue(Channel3);//获取风速传感器的数值(未转换公式)
  67   1          dh11Data=DHT11_receive();
  68   1          globalSensorValue.TemperatureValue=dh11Data.TH;//温度值
  69   1          globalSensorValue.HumidityValue=dh11Data.RH;//湿度值
  70   1          //以下仅用于测试发送到串口看是否正确
  71   1          sendThresholdToPhone(&dh11Data.RH);//湿度值 
  72   1          sendThresholdToPhone(&dh11Data.TH); //温度值
  73   1          handleSensorDataAnalysis(); 
  74   1          return true;
  75   1      }
  76          static const bool handleSensorDataAnalysis(void)
  77          {
  78   1        bool  isSendSmsInfo=false;
  79   1        isSendSmsInfo=globalSensorValue.PhotosensitiveValue>=PhotosensitiveThreshold?true:false;
  80   1        if(isSendSmsInfo)
  81   1            goto DataAnalysis;
  82   1        isSendSmsInfo=globalSensorValue.RaindropValue>=RaindropThreshold?true:false;
  83   1        if(isSendSmsInfo)
  84   1            goto DataAnalysis;  
  85   1        isSendSmsInfo=globalSensorValue.WindSpeedValue>=WindSpeedThreshold?true:false;
  86   1        if(isSendSmsInfo)
  87   1            goto DataAnalysis;  
  88   1        isSendSmsInfo=globalSensorValue.TemperatureValue>=TemperatureThreshold?true:false;
  89   1        if(isSendSmsInfo)
  90   1            goto DataAnalysis;
  91   1        isSendSmsInfo=globalSensorValue.HumidityValue>=HumidityThreshold?true:false;
  92   1      DataAnalysis: 
  93   1        if(isSendSmsInfo){//发送温湿度短信(温度阈值达到)
  94   2          //此时此刻电机已经收缩状态
  95   2          if(CLOSE==byte_read(MotorStatusAddress))
  96   2            return false;
  97   2          //控制电机1收衣服
  98   2          this.controlMotor1StatusFunc(Move_Up);
  99   2          //电磁铁开
 100   2          this.handleControlMagnetFunc(true);
 101   2          //控制电机2收遮雨布
 102   2          this.controlMotor2StatusFunc(Move_Up);  
 103   2          //电磁铁关
 104   2          this.handleControlMagnetFunc(false);
 105   2          //发送短信给手机
 106   2          handleSendSmsInfo();
 107   2          //保存电机状态
 108   2          byte_write(MotorStatusAddress,CLOSE);
 109   2        }else{
 110   2          //todo 去晒衣服 
 111   2        //此时此刻电机已经晒衣服状态
 112   2          if(OPEN==byte_read(MotorStatusAddress))
 113   2            return false;
 114   2          //电磁铁开
 115   2          this.handleControlMagnetFunc(true);   
 116   2          //控制电机2晒衣服
C51 COMPILER V9.59.0.0   GLOBALMANAGER                                                     04/25/2019 14:08:00 PAGE 3   

 117   2          this.controlMotor2StatusFunc(Move_Down);
 118   2          //电磁铁关
 119   2          this.handleControlMagnetFunc(false);    
 120   2          //控制电机1晒衣服
 121   2          this.controlMotor1StatusFunc(Move_Down);
 122   2          //发送短信给手机
 123   2          handleSendSmsInfo();
 124   2          //保存电机状态
 125   2          byte_write(MotorStatusAddress,OPEN);
 126   2        }
 127   1        return true;
 128   1      }
 129          static const bool handleSendSmsInfo(void)
 130          {
 131   1        //todo发送gsm的信息
 132   1        uint8_t xdata sendSmsBuff[50];
 133   1        memset(sendSmsBuff,0,sizeof(uint8_t)*50);
 134   1        sprintf(sendSmsBuff,"Light:%d,Rain:%d,Wind:%d,Temp:%d,Hum:%d",globalSensorValue.PhotosensitiveValue\
 135   1                                                                      ,globalSensorValue.RaindropValue\
 136   1                                                                      ,globalSensorValue.WindSpeedValue\
 137   1                                                                      ,globalSensorValue.TemperatureValue\
 138   1                                                                      ,globalSensorValue.HumidityValue);
 139   1        sendThresholdToPhone(sendSmsBuff);
 140   1        return true;
 141   1      }
 142          void g_delay(const uint32_t one_10us)
 143          {
 144   1        if(!one_10us)
 145   1          return;
 146   1        g_EndCount=one_10us;
 147   1        g_CurrentCount=0;
 148   1        forever{
 149   2          if(g_CurrentCount>=g_EndCount)
 150   2            break;
 151   2        }
 152   1      }
 153          static void  interrupt1Init()
 154          {
 155   1        EA = OPEN;
 156   1        TMOD = 0x11;
 157   1        ET0 = OPEN;
 158   1        //10 us
 159   1        TH0=(65536-10)/256;
 160   1        TL0=(65536-10)%256;
 161   1        TR0=OPEN;
 162   1      }
 163          static void  uartInit()
 164          {
 165   1        //设置9600的波特率
 166   1      #ifdef RATE12
 167   1          RCAP2L=0xD9;
 168   1          RCAP2H=0xFF;
 169   1          T2CON=0x34;
 170   1          SCON=0x50;
 171   1          ES=OPEN;
 172   1          EA=OPEN;
 173   1      #else
                  PCON &= 0x7F;
                  SCON = 0x50;
                  TMOD &= 0x0F; 
                  TMOD |= 0x20;
                  TL1 = 0xFD;
C51 COMPILER V9.59.0.0   GLOBALMANAGER                                                     04/25/2019 14:08:00 PAGE 4   

                  TH1 = 0xFD;
                  ET1 = 0;
                  TR1 = OPEN; 
                  ES  = OPEN;
              #endif
 184   1      }
 185          static const bool handleControlMagnet(const bool isOpen)
 186          {
 187   1        //电磁铁控制开关
 188   1        if(isOpen){
 189   2            MagnetSwitch=OPEN;//高电平开
 190   2        }else{
 191   2            MagnetSwitch=CLOSE; //低电平关闭    
 192   2        }
 193   1        return true;
 194   1      }
 195          /*******************************************************************************
 196          * 函 数 名         : timeout
 197          * 函数功能       :定时器中断触发
 198          * 输    入         : 无
 199          * 输    出         : 无
 200          *******************************************************************************/
 201          void timeout(void) interrupt 1
 202          {
 203   1        //10 us
 204   1        TH0=(65536-10)/256;
 205   1        TL0=(65536-10)%256;
 206   1      
 207   1        g_CurrentCount++;
 208   1        ADC_CLOCK=~ADC_CLOCK;//给adc模块发送方波
 209   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    642    ----
   CONSTANT SIZE    =     40    ----
   XDATA SIZE       =   ----      50
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     24       2
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
